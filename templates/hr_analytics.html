<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Analytique RH - Analytics Avanc√©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.10.2/lottie.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/analytics_hr.css') }}">
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <h2>Navigation</h2>
            <div class="nav-item active" onclick="showTab('overview')">
                <i class="fas fa-chart-line"></i> Vue d'Ensemble
            </div>
            <div class="nav-item" onclick="showTab('hours')">
                <i class="fas fa-clock"></i> Heures
            </div>
            <div class="nav-item" onclick="showTab('overtime')">
                <i class="fas fa-fire"></i> Heures Sup
            </div>
            <div class="nav-item" onclick="showTab('patterns')">
                <i class="fas fa-calendar-week"></i> Mod√®les
            </div>
            <div class="nav-item" onclick="showTab('insights')">
                <i class="fas fa-lightbulb"></i> Insights
            </div>
            <div class="nav-item" onclick="showTab('categories')">
                <i class="fas fa-tags"></i> Cat√©gories
            </div>
            <div class="nav-item" onclick="showTab('individuals')">
                <i class="fas fa-user-friends"></i> Employ√©s
            </div>
            <div class="nav-item" onclick="showTab('efficiency')">
                <i class="fas fa-tachometer-alt"></i> Efficacit√©
            </div>
            <div class="nav-item" onclick="showTab('seasonality')">
                <i class="fas fa-leaf"></i> Saisonnalit√©
            </div>
        </nav>

        <div style="flex: 1;">
            <div id="connectionStatus" class="connection-status connection-offline">
                <i class="fas fa-circle"></i> Connexion Base de Donn√©es
            </div>

            <header class="header">
                <div class="header-content">
                    <h1><i class="fas fa-chart-line"></i> Dashboard RH Analytics Avanc√©</h1>
                    <p>Analyse Compl√®te des Tendances de Pointage - Insights Strat√©giques</p>
                </div>
                <div class="header-actions">
                    <div class="year-selector">
                        <label for="yearSelect">Ann√©e :</label>
                        <select id="yearSelect" class="year-select" onchange="onYearChange()">
                            <option value="">Toutes les ann√©es</option>
                        </select>
                    </div>
                    <div class="advanced-filters">
                        <div class="filter-control">
                            <label for="headerServiceFilter">Service</label>
                            <select id="headerServiceFilter" class="filter-select" onchange="onAdvancedFiltersChange()">
                                <option value="">Tous</option>
                            </select>
                        </div>
                        <div class="filter-control">
                            <label>Plage mois</label>
                            <div class="month-range">
                                <select id="headerMonthStart" class="filter-select small" onchange="onAdvancedFiltersChange()"></select>
                                <span>‚Üí</span>
                                <select id="headerMonthEnd" class="filter-select small" onchange="onAdvancedFiltersChange()"></select>
                            </div>
                        </div>
                    </div>
                    <div class="header-buttons">
                        <button class="btn btn-refresh" onclick="refreshDashboard()">‚Üª Actualiser</button>
                        <button class="btn" onclick="toggleDarkMode()" id="themeToggle">üåô Mode Sombre</button>
                        <a href="{{ url_for('login.homepage') }}" class="btn btn-home">üè† Accueil</a>
                    </div>
                </div>
            </header>

            <div class="dashboard-container">
                <div id="loadingIndicator" class="loading">
                    <div class="loading-bg"></div>
                    <div class="loading-content">
                        <div id="lottie-loader"></div>
                        <p>Chargement des donn√©es depuis Oracle...</p>
                    </div>
                </div>

                <div id="dashboardContent" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-fingerprint"></i></div>
                            <div class="stat-value" id="totalPointages">-</div>
                            <div class="stat-label">Total Pointages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                            <div class="stat-value" id="pointagesAnnuels">-</div>
                            <div class="stat-label" id="pointagesYearLabel">Pointages s√©lection</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-users"></i></div>
                            <div class="stat-value" id="uniqueEmployees">-</div>
                            <div class="stat-label">Employ√©s Totaux</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                            <div class="stat-value" id="employesActifs">-</div>
                            <div class="stat-label" id="actifsYearLabel">Employ√©s s√©lection</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-building"></i></div>
                            <div class="stat-value" id="activeServices">-</div>
                            <div class="stat-label">Services Actifs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-value" id="avgHours">-</div>
                            <div class="stat-label" id="avgHoursLabel">Heures Moy/Jour (Ann√©e)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-chart-area"></i></div>
                            <div class="stat-value" id="totalHours">-</div>
                            <div class="stat-label" id="totalHoursLabel">Total Heures (Ann√©e)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-history"></i></div>
                            <div class="stat-value" id="yearsCovered">-</div>
                            <div class="stat-label">Ann√©es Couvertes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-sign-in-alt"></i></div>
                            <div class="stat-value" id="peakEntryHour">-</div>
                            <div class="stat-label" id="peakEntryLabel">Heure Pointe Entr√©e</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-sign-out-alt"></i></div>
                            <div class="stat-value" id="peakExitHour">-</div>
                            <div class="stat-label" id="peakExitLabel">Heure Pointe Sortie</div>
                        </div>
                    </div>

                    <!-- Overview Section -->
                    <div id="overview" class="tab-content active">
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-line"></i> Tendances Mensuelles</span>
                                    <span class="info-chip" data-tip="√âvolution mensuelle des heures travaill√©es et du volume d'employ√©s actifs.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="monthlyTrendsChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-bar"></i> Performance par Service</span>
                                    <span class="info-chip" data-tip="Compare les services selon les heures totales et le nombre d'employ√©s uniques.">i</span>
                                </h3>
                                <div class="chart-container tall"><canvas id="serviceYearlyChart"></canvas></div>
                            </div>
                        </div>
                        <div class="data-table">
                            <table id="yearlyStatsTable">
                                <thead>
                                    <tr>
                                        <th>Ann√©e</th>
                                        <th>Employ√©s</th>
                                        <th>Pointages</th>
                                        <th>Total Heures</th>
                                        <th>Heures Moyennes</th>
                                        <th>√âvolution</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Hours Section -->
                    <div id="hours" class="tab-content">
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-clock"></i> Heures Moyennes par Service</span>
                                    <span class="info-chip" data-tip="Temps de travail quotidien moyen observ√© dans chaque service.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="hoursBarChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-line"></i> Tendance Heures de Travail</span>
                                    <span class="info-chip" data-tip="Suit les heures cumul√©es pour rep√©rer les pics d‚Äôactivit√© dans le temps.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="hoursTrendChart"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <!-- Overtime Section -->
                    <div id="overtime" class="tab-content">
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-fire"></i> Taux Heures Suppl√©mentaires</span>
                                    <span class="info-chip" data-tip="Pourcentage d'heures suppl√©mentaires effectu√©es par service.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="overtimeChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-area"></i> Volume Heures Suppl√©mentaires</span>
                                    <span class="info-chip" data-tip="Volume total d'heures suppl√©mentaires et relation avec l'effectif.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="overtimeVolumeChart"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <!-- Patterns Section -->
                    <div id="patterns" class="tab-content">
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-sun"></i> Heures de Pointe</span>
                                    <span class="info-chip" data-tip="Heures d'entr√©e o√π les pointages sont les plus fr√©quents.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="peakHoursChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-calendar-week"></i> Mod√®le Hebdomadaire</span>
                                    <span class="info-chip" data-tip="Pr√©sence moyenne par jour de la semaine pour rep√©rer les creux.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="weeklyPatternChart"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Section -->
                    <div id="insights" class="tab-content">
                        <div class="insights-grid" id="insightsContainer"></div>
                    </div>

                    <!-- Categories Section -->
                    <div id="categories" class="tab-content">
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-pie"></i> R√©partition Cat√©gories</span>
                                    <span class="info-chip" data-tip="Part des cat√©gories d‚Äôemploi dans les pointages enregistr√©s.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="categoriesChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-bar"></i> Heures par Cat√©gorie</span>
                                    <span class="info-chip" data-tip="Comparer les heures totales et moyennes r√©alis√©es par cat√©gorie.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="categoriesHoursChart"></canvas></div>
                            </div>
                        </div>
                        <div class="data-table">
                            <table id="categoriesTable">
                                <thead>
                                    <tr>
                                        <th>Cat√©gorie</th>
                                        <th>Employ√©s</th>
                                        <th>Total Heures</th>
                                        <th>Heures Moyennes</th>
                                        <th>Pointages</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Individuals Section -->
                    <div id="individuals" class="tab-content">
                        <div class="info-banner compact">
                            <div>
                                <p>Suivi des <strong>3 derniers mois</strong> : r√©gularit√© = assiduit√© + respect des 8h/jour. Utilisez la recherche employ√© pour un zoom individuel.</p>
                            </div>
                            <div class="legend-row slim">
                                <span><span class="status-badge status-excellent">80%+</span> solide</span>
                                <span><span class="status-badge status-moyen">60-79%</span> √† surveiller</span>
                                <span><span class="status-badge status-faible">&lt;60%</span> critique</span>
                            </div>
                        </div>
                        <div class="filters-row employee-drilldown-controls">
                            <div class="year-selector">
                                <label for="employeeSelect">Employ√© :</label>
                                <select id="employeeSelect" class="year-select">
                                    <option value="">S√©lectionnez un employ√©</option>
                                </select>
                            </div>
                            <div class="date-range">
                                <label for="employeeStart">Du</label>
                                <input type="date" id="employeeStart" class="year-select">
                                <label for="employeeEnd">Au</label>
                                <input type="date" id="employeeEnd" class="year-select">
                            </div>
                            <div class="button-group">
                                <button class="btn" onclick="onEmployeeFilterSubmit()">Analyser</button>
                                <button class="btn btn-secondary" onclick="resetEmployeeFilter()">R√©initialiser</button>
                            </div>
                        </div>
                        <div id="employeeDrilldownMessage" class="alert" style="display:none;"></div>
                        <div id="employeeDrilldown" class="employee-drilldown" style="display:none;">
                            <div class="stats-grid" id="employeeDrilldownStats"></div>
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-line"></i> Courbe Quotidienne</span>
                                    <span class="info-chip" data-tip="Heures r√©alis√©es jour par jour pour l'employ√© s√©lectionn√©.">i</span>
                                </h3>
                                <div class="chart-container tall">
                                    <canvas id="employeeDrilldownChart"></canvas>
                                    <div class="chart-empty" id="employeeDrilldownChartEmpty">S√©lectionnez un employ√© et une p√©riode pour afficher les donn√©es.</div>
                                </div>
                            </div>
                            <div class="data-table">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-calendar-day"></i> Journal de pr√©sence</span>
                                    <span class="info-chip" data-tip="D√©tail quotidien des heures et services pour l‚Äôemploy√© choisi.">i</span>
                                </h3>
                                <table id="employeeDrilldownTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Service</th>
                                            <th>Heures</th>
                                            <th>Heures Sup</th>
                                            <th>Pr√©sent</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="insights-grid" id="individualHighlights"></div>

                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-bar"></i> Scores des Employ√©s R√©guliers</span>
                                    <span class="info-chip" data-tip="Met en avant les meilleurs scores de r√©gularit√© (assiduit√© + respect horaire).">i</span>
                                </h3>
                                <div class="chart-container tall">
                                    <canvas id="regularEmployeesChart"></canvas>
                                    <div class="chart-empty" id="regularEmployeesChartEmpty">Aucune donn√©e pour la s√©lection.</div>
                                </div>
                            </div>
                        </div>
                        <div class="data-table branded-table">
                            <div class="table-header">
                                <h3><i class="fas fa-user-check"></i> D√©tails Employ√©s R√©guliers</h3>
                                <p>Top contributeurs, class√©s par score combin√© assiduit√©/horaires.</p>
                            </div>
                            <div id="regularEmployeesCards" class="employee-card-grid"></div>
                        </div>
                        <div class="data-table branded-table">
                            <div class="table-header">
                                <h3><i class="fas fa-user-clock"></i> D√©tails Employ√©s Irr√©guliers</h3>
                                <p>Individus √† accompagner en priorit√© (jours manquants / heures insuffisantes).</p>
                            </div>
                            <div id="irregularEmployeesCards" class="employee-card-grid"></div>
                        </div>
                    </div>

                    <!-- Efficiency Section -->
                    <div id="efficiency" class="tab-content">
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-tachometer-alt"></i> Score Productivit√©</span>
                                    <span class="info-chip" data-tip="Classe les services selon leur score de productivit√© normalis√©.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="productivityChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-scatter"></i> Analyse Efficacit√©</span>
                                    <span class="info-chip" data-tip="Dispersion des services par variation d'heures et performance.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="efficiencyScatterChart"></canvas></div>
                            </div>
                        </div>
                        <div class="data-table">
                            <table id="efficiencyTable">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Employ√©s</th>
                                        <th>Score Productivit√©</th>
                                        <th>Variation</th>
                                        <th>Pointages/Employ√©</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Seasonality Section -->
                    <div id="seasonality" class="tab-content">
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-leaf"></i> Analyse Saisonni√®re</span>
                                    <span class="info-chip" data-tip="Compare les heures moyennes r√©alis√©es durant chaque saison.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="seasonalChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">
                                    <span class="chart-title-text"><i class="fas fa-chart-line"></i> Tendances Saisonni√®res</span>
                                    <span class="info-chip" data-tip="Met en lumi√®re le volume moyen d‚Äôemploy√©s actifs par saison.">i</span>
                                </h3>
                                <div class="chart-container"><canvas id="seasonTrendsChart"></canvas></div>
                            </div>
                        </div>
                        <div class="insights-grid" id="seasonalInsights"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = {};
        let charts = {};
        let selectedYear = null;
        let hasUserSelectedYear = false;
        let employeeDirectory = [];
        let employeeDrilldownData = null;
        const headerFilters = {
            service: '',
            monthStart: '',
            monthEnd: ''
        };
        const MONTH_LABELS = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];

        // Fetch data from backend
        async function fetchDataFromOracle(year = null, options = {}) {
            try {
                let url = '/api/dashboard';
                const queryParts = [];

                if (options.forceAll) {
                    queryParts.push('mode=all');
                } else if (typeof year === 'number' && !Number.isNaN(year)) {
                    queryParts.push(`year=${year}`);
                }

                if (headerFilters.service) {
                    queryParts.push(`service=${encodeURIComponent(headerFilters.service)}`);
                }
                const monthStart = parseInt(headerFilters.monthStart, 10);
                const monthEnd = parseInt(headerFilters.monthEnd, 10);
                if (!Number.isNaN(monthStart)) {
                    queryParts.push(`month_from=${monthStart}`);
                }
                if (!Number.isNaN(monthEnd)) {
                    queryParts.push(`month_to=${monthEnd}`);
                }

                if (queryParts.length > 0) {
                    url += `?${queryParts.join('&')}`;
                }

                const response = await axios.get(url);
                if (response.status !== 200) {
                    throw new Error('Failed to fetch data from backend');
                }
                return response.data;
            } catch (error) {
                console.error('Erreur de connexion √† la base de donn√©es:', error);
                throw error;
            }
        }

        function createPatternCharts() {
            const peakHours = dashboardData.peakHours || [];
            const peakHoursExit = dashboardData.peakHoursExit || [];
            const weeklyPattern = dashboardData.weeklyPattern || [];
            
            if (peakHours.length > 0 || peakHoursExit.length > 0) {
                const hoursMap = new Map();
                const trackHours = (data, valueKeys) => {
                    data.forEach(item => {
                        const rawHour = typeof item.heure === 'number'
                            ? item.heure
                            : (item.heure_entree_parsee ?? item.heure_sortie_parsee);
                        if (!isFinite(rawHour)) {
                            return;
                        }
                        const hourValue = Math.floor(rawHour);
                        const current = hoursMap.get(hourValue) || { entree: 0, sortie: 0 };
                        const value = valueKeys.reduce((val, key) => {
                            if (val !== null && val !== undefined) {
                                return val;
                            }
                            return item[key];
                        }, null);
                        const resolved = typeof value === 'number' && isFinite(value)
                            ? value
                            : (typeof item.mat_pers === 'number' ? item.mat_pers : 0);
                        const targetKey = valueKeys.includes('nombre_sorties') ? 'sortie' : 'entree';
                        current[targetKey] = (current[targetKey] || 0) + resolved;
                        hoursMap.set(hourValue, current);
                    });
                };

                trackHours(peakHours, ['nombre_entrees']);
                trackHours(peakHoursExit, ['nombre_sorties']);

                const sortedHours = Array.from(hoursMap.keys()).sort((a, b) => a - b);
                const labels = sortedHours.map(hour => `${String(hour).padStart(2, '0')}h00`);
                const entryValues = sortedHours.map(hour => hoursMap.get(hour)?.entree || 0);
                const exitValues = sortedHours.map(hour => hoursMap.get(hour)?.sortie || 0);

                initializeChart('peakHoursChart', {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Entr√©es',
                            data: entryValues,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 2
                        }, {
                            label: 'Sorties',
                            data: exitValues,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: { 
                            y: { beginAtZero: true, title: { display: true, text: 'Pr√©sences' } }
                        }
                    }
                });
            }

            if (weeklyPattern.length > 0) {
                initializeChart('weeklyPatternChart', {
                    type: 'radar',
                    data: {
                        labels: weeklyPattern.map(d => d.jour_semaine || 'Inconnu'),
                        datasets: [{
                            label: 'Pr√©sences',
                            data: weeklyPattern.map(d => d.nombre_presences || d.mat_pers || 0),
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 3,
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: { r: { beginAtZero: true } }
                    }
                });
            }
        }

        // Initialize dashboard
        async function initDashboard() {
            try {
                document.getElementById('connectionStatus').className = 'connection-status connection-online';
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-circle"></i> Connect√© √† Oracle';

                await loadDashboardData(selectedYear);

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
            } catch (error) {
                document.getElementById('loadingIndicator').innerHTML = 
                    '<div class="error"><i class="fas fa-exclamation-triangle"></i> Erreur de connexion: ' + error.message + '</div>';
                document.getElementById('connectionStatus').className = 'connection-status connection-offline';
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-circle"></i> D√©connect√©';
            }
        }

        // Transform backend data
        function transformData(backendData) {
            return {
                workingHours: backendData.assiduite?.heures_travail_moyennes || [],
                overtime: backendData.assiduite?.analyse_heures_supplementaires || [],
                peakHours: backendData.assiduite?.heures_de_pointe || [],
                peakHoursExit: backendData.assiduite?.heures_de_pointe_sortie || [],
                weeklyPattern: backendData.assiduite?.modele_hebdomadaire || [],
                summary: backendData.summary || {},
                yearlyTrends: backendData.yearly_trends || {},
                categories: backendData.employee_categories || [],
                seasonality: backendData.seasonality || {},
                efficiency: backendData.service_efficiency || [],
                individualPresence: backendData.individual_presence || {}
            };
        }

        async function loadDashboardData(year = selectedYear, options = {}) {
            const activeTab = document.querySelector('.tab-content.active');
            const activeTabId = activeTab ? activeTab.id : 'overview';

            const forceAll = options.forceAll || (hasUserSelectedYear && selectedYear === null && (year === null || typeof year !== 'number'));
            const backendData = await fetchDataFromOracle(
                forceAll ? null : year,
                { forceAll }
            );
            dashboardData = transformData(backendData);

            populateYearSelector(dashboardData.summary);
            populateAdvancedFilterOptions(dashboardData);

            if (!forceAll && year !== selectedYear) {
                await loadDashboardData(selectedYear);
                return;
            }

            updateSummaryStats();
            createAllTables();
            generateInsights();
            showTab(activeTabId);
        }

        async function refreshDashboard() {
            showLoader();
            try {
                await loadDashboardData(selectedYear, { forceAll: selectedYear === null });
            } catch (error) {
                console.error('Erreur lors du rafra√Æchissement du tableau de bord:', error);
            } finally {
                hideLoader();
                document.getElementById('dashboardContent').style.display = 'block';
            }
        }

        function populateYearSelector(summary) {
            const select = document.getElementById('yearSelect');
            if (!select) {
                return;
            }

            const years = summary?.annees_couvertes || [];
            select.innerHTML = '<option value="">Toutes les ann√©es</option>';

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            });

            if (!hasUserSelectedYear && selectedYear === null && summary?.selected_year) {
                selectedYear = summary.selected_year;
            }

            if (selectedYear !== null && years.includes(selectedYear)) {
                select.value = String(selectedYear);
            } else {
                select.value = '';
            }
        }

        function ensureMonthFilterOptions() {
            const startSelect = document.getElementById('headerMonthStart');
            const endSelect = document.getElementById('headerMonthEnd');
            if (!startSelect || startSelect.options.length > 0) {
                return;
            }
            const buildOptions = () => {
                const opts = ['<option value=\"\">Tous</option>'];
                MONTH_LABELS.forEach((label, index) => {
                    const value = index + 1;
                    opts.push(`<option value=\"${value}\">${value.toString().padStart(2, '0')} - ${label}</option>`);
                });
                return opts.join('');
            };
            const optionsMarkup = buildOptions();
            startSelect.innerHTML = optionsMarkup;
            endSelect.innerHTML = optionsMarkup;
            startSelect.value = headerFilters.monthStart || '';
            endSelect.value = headerFilters.monthEnd || '';
        }

        function fillFilterSelect(select, values, currentValue, defaultLabel, filterKey) {
            if (!select) {
                return;
            }
            const options = [`<option value=\"\">${defaultLabel}</option>`];
            values.forEach(value => {
                options.push(`<option value=\"${value}\">${value}</option>`);
            });
            select.innerHTML = options.join('');
            if (currentValue && values.includes(currentValue)) {
                select.value = currentValue;
            } else {
                select.value = '';
                if (currentValue) {
                    headerFilters[filterKey] = '';
                }
            }
        }

        function populateAdvancedFilterOptions(data) {
            ensureMonthFilterOptions();
            const serviceSelect = document.getElementById('headerServiceFilter');
            if (!serviceSelect) {
                return;
            }

            const services = new Set();
            const pushService = service => {
                if (service) {
                    services.add(service);
                }
            };
            (data.service_efficiency || []).forEach(item => pushService(item.service));
            (data.assiduite?.heures_travail_moyennes || []).forEach(item => pushService(item.service));
            (data.summary?.services_actifs_liste || []).forEach(pushService);
            fillFilterSelect(serviceSelect, Array.from(services).sort((a, b) => a.localeCompare(b)), headerFilters.service, 'Tous', 'service');

            const startSelect = document.getElementById('headerMonthStart');
            const endSelect = document.getElementById('headerMonthEnd');
            if (startSelect) {
                startSelect.value = headerFilters.monthStart || '';
            }
            if (endSelect) {
                endSelect.value = headerFilters.monthEnd || '';
            }
        }

        async function onYearChange() {
            const select = document.getElementById('yearSelect');
            if (!select) {
                return;
            }

            const value = select.value;
            selectedYear = value ? parseInt(value, 10) : null;
            if (Number.isNaN(selectedYear)) {
                selectedYear = null;
            }

            hasUserSelectedYear = true;
            showLoader();

            try {
                await loadDashboardData(selectedYear, { forceAll: selectedYear === null });
                document.getElementById('dashboardContent').style.display = 'block';
            } catch (error) {
                console.error('Erreur lors du changement d\'ann√©e:', error);
            } finally {
                hideLoader();
            }
        }

        async function onAdvancedFiltersChange() {
            const serviceSelect = document.getElementById('headerServiceFilter');
            const startSelect = document.getElementById('headerMonthStart');
            const endSelect = document.getElementById('headerMonthEnd');

            headerFilters.service = serviceSelect ? serviceSelect.value : '';
            headerFilters.monthStart = startSelect ? startSelect.value : '';
            headerFilters.monthEnd = endSelect ? endSelect.value : '';

            showLoader();
            try {
                await loadDashboardData(selectedYear, { forceAll: selectedYear === null });
                document.getElementById('dashboardContent').style.display = 'block';
            } catch (error) {
                console.error('Erreur lors de l\'application des filtres avanc√©s:', error);
            } finally {
                hideLoader();
            }
        }

        // Update summary stats
        function updateSummaryStats() {
            const summary = dashboardData.summary || {};
            const formatNumber = value => (typeof value === 'number' && !isNaN(value) ? value.toLocaleString() : '0');
            const formatHoursValue = value => (typeof value === 'number' && !isNaN(value) ? value.toFixed(2) : '0');
            const formatHourValue = hour => {
                if (typeof hour === 'number' && isFinite(hour)) {
                    const rounded = Math.floor(hour);
                    return `${String(rounded).padStart(2, '0')}h`;
                }
                return '‚Äî';
            };

            const summarySelectedYear = summary.selected_year ?? null;
            const yearForLabel = selectedYear !== null ? selectedYear : summarySelectedYear;
            const usingAllYears = yearForLabel === null;
            const yearLabelText = usingAllYears ? 'Toutes ann√©es' : yearForLabel;

            document.getElementById('totalPointages').textContent = formatNumber(summary.total_pointages);
            document.getElementById('pointagesAnnuels').textContent = formatNumber(summary.total_pointages_annee_courante);
            document.getElementById('pointagesYearLabel').textContent = usingAllYears ? 'Pointages (Toutes ann√©es)' : `Pointages ${yearLabelText}`;

            document.getElementById('uniqueEmployees').textContent = formatNumber(summary.employes_uniques_total);
            document.getElementById('employesActifs').textContent = formatNumber(summary.employes_uniques);
            document.getElementById('actifsYearLabel').textContent = usingAllYears ? 'Employ√©s (Toutes ann√©es)' : `Employ√©s ${yearLabelText}`;

            document.getElementById('activeServices').textContent = formatNumber(summary.services_actifs);
            document.getElementById('avgHours').textContent = `${formatHoursValue(summary.avg_daily_hours_current_year)}h`;
            document.getElementById('avgHoursLabel').textContent = usingAllYears ? 'Heures Moy/Jour (Toutes ann√©es)' : `Heures Moy/Jour (${yearLabelText})`;

            const totalHoursValue = usingAllYears ? summary.total_work_hours : summary.total_work_hours_selected;
            document.getElementById('totalHours').textContent = `${formatNumber(totalHoursValue)}h`;
            document.getElementById('totalHoursLabel').textContent = usingAllYears ? 'Total Heures (Toutes ann√©es)' : `Total Heures (${yearLabelText})`;

            const yearsCoveredCount = Array.isArray(summary.annees_couvertes) ? summary.annees_couvertes.length : 0;
            document.getElementById('yearsCovered').textContent = formatNumber(yearsCoveredCount);

            const computePeak = (data, countKeys = []) => {
                if (!Array.isArray(data) || data.length === 0) {
                    return null;
                }
                return data.reduce((best, item) => {
                    const hourCandidate = typeof item.heure === 'number'
                        ? item.heure
                        : (item.heure_entree_parsee ?? item.heure_sortie_parsee);
                    const countCandidate = countKeys.reduce((val, key) => {
                        if (val !== null && val !== undefined) {
                            return val;
                        }
                        return item[key];
                    }, null);
                    const resolvedCount = typeof countCandidate === 'number' && isFinite(countCandidate)
                        ? countCandidate
                        : (typeof item.mat_pers === 'number' ? item.mat_pers : 0);
                    if (!isFinite(hourCandidate) || resolvedCount <= 0) {
                        return best;
                    }
                    if (best === null || resolvedCount > best.count) {
                        return { hour: hourCandidate, count: resolvedCount };
                    }
                    return best;
                }, null);
            };

            const entryPeak = computePeak(dashboardData.peakHours, ['nombre_entrees']);
            const exitPeak = computePeak(dashboardData.peakHoursExit, ['nombre_sorties']);

            const peakEntryValueEl = document.getElementById('peakEntryHour');
            const peakEntryLabelEl = document.getElementById('peakEntryLabel');
            const peakExitValueEl = document.getElementById('peakExitHour');
            const peakExitLabelEl = document.getElementById('peakExitLabel');

            if (peakEntryValueEl) {
                peakEntryValueEl.textContent = formatHourValue(entryPeak?.hour);
            }
            if (peakEntryLabelEl) {
                const countText = entryPeak?.count ? entryPeak.count.toLocaleString() : '0';
                peakEntryLabelEl.textContent = `Entr√©es (${countText})`;
            }
            if (peakExitValueEl) {
                peakExitValueEl.textContent = formatHourValue(exitPeak?.hour);
            }
            if (peakExitLabelEl) {
                const countText = exitPeak?.count ? exitPeak.count.toLocaleString() : '0';
                peakExitLabelEl.textContent = `Sorties (${countText})`;
            }
        }

        // Helper function to safely initialize a chart
        function initializeChart(canvasId, chartConfig) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    if (charts[canvasId]) {
                        charts[canvasId].destroy();
                    }
                    charts[canvasId] = new Chart(ctx, chartConfig);
                }
            } else {
                console.warn(`Canvas with ID ${canvasId} not found`);
            }
        }

        // Chart creation functions
        function createYearlyTrendsCharts() {
            const allYearlyData = dashboardData.yearlyTrends.yearly_overview || [];
            const trendSelectedYear = selectedYear !== null ? selectedYear : (dashboardData.yearlyTrends.selected_year || null);
            const filteredYearlyData = selectedYear !== null ? allYearlyData.filter(d => d.annee === selectedYear) : allYearlyData;
            const yearlyData = filteredYearlyData.length > 0 ? filteredYearlyData : allYearlyData;

            const monthlyData = dashboardData.yearlyTrends.monthly_current_year || [];
            const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
            const monthYearLabel = trendSelectedYear !== null ? trendSelectedYear : '';
            if (monthlyData.length > 0) {
                initializeChart('monthlyTrendsChart', {
                    type: 'line',
                    data: {
                        labels: monthlyData.map(d => monthNames[d.mois - 1] || d.mois),
                        datasets: [{
                            label: monthYearLabel ? `Employ√©s Actifs (${monthYearLabel})` : 'Employ√©s Actifs',
                            data: monthlyData.map(d => d.employes_actifs),
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Nombre d\'employ√©s' }
                            }
                        }
                    }
                });
            }

            const serviceYearlyDataRaw = dashboardData.yearlyTrends.service_yearly_performance || [];
            const serviceYearlyData = selectedYear !== null
                ? serviceYearlyDataRaw.filter(d => d.annee_pointage === selectedYear || d.annee === selectedYear)
                : serviceYearlyDataRaw;

            if (serviceYearlyData.length > 0) {
                const services = [...new Set(serviceYearlyData.map(d => d.libelle_y))];
                const years = [...new Set(serviceYearlyData.map(d => d.annee_pointage || trendSelectedYear))].sort();

                const colorPalette = services.map((_, index) => {
                    const hue = (index * 47) % 360;
                    return {
                        fill: `hsla(${hue}, 70%, 55%, 0.75)`,
                        border: `hsla(${hue}, 70%, 40%, 1)`
                    };
                });

                const datasets = services.map((service, index) => {
                    const colors = colorPalette[index];
                    return {
                        label: service,
                        data: years.map(year => {
                            const record = serviceYearlyData.find(
                                d => (d.annee_pointage || trendSelectedYear) === year && d.libelle_y === service
                            );
                            return record ? record.total_heures : 0;
                        }),
                        backgroundColor: colors.fill,
                        borderColor: colors.border,
                        borderWidth: 2
                    };
                });

                initializeChart('serviceYearlyChart', {
                    type: 'bar',
                    data: { 
                        labels: years.map(y => y ? y.toString() : ''), 
                        datasets: datasets 
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                title: { display: true, text: 'Total Heures' }
                            }
                        }
                    }
                });
            }
        }

        function createWorkingHoursCharts() {
            const workingHours = dashboardData.workingHours || [];
            
            if (workingHours.length > 0) {
                // Bar chart for average hours by service
                initializeChart('hoursBarChart', {
                    type: 'bar',
                    data: {
                        labels: workingHours.map(d => d.service),
                        datasets: [{
                            label: 'Heures/Jour',
                            data: workingHours.map(d => d.heures_moyennes_par_jour),
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Heures par jour' }
                            }
                        }
                    }
                });

                // Line chart for trend visualization
                initializeChart('hoursTrendChart', {
                    type: 'line',
                    data: {
                        labels: workingHours.map(d => d.service),
                        datasets: [{
                            label: 'Heures Moyennes',
                            data: workingHours.map(d => d.heures_moyennes_par_jour),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Heures moyennes' }
                            },
                            x: { 
                                ticks: { maxRotation: 45 }
                            }
                        }
                    }
                });
            }
        }

        function createOvertimeCharts() {
            const overtimeData = dashboardData.overtime || [];
            
            if (overtimeData.length > 0) {
                // Bar chart for overtime rates
                initializeChart('overtimeChart', {
                    type: 'bar',
                    data: {
                        labels: overtimeData.map(d => d.libelle_y),
                        datasets: [{
                            label: 'Taux Heures Sup (%)',
                            data: overtimeData.map(d => d.taux_heures_sup || 0),
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                max: 100,
                                title: { display: true, text: 'Taux (%)' }
                            },
                            x: { 
                                ticks: { maxRotation: 45 }
                            }
                        }
                    }
                });

                // Scatter chart for overtime volume analysis
                initializeChart('overtimeVolumeChart', {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Volume Heures Suppl√©mentaires',
                            data: overtimeData.map((d, index) => ({
                                x: d.taux_heures_sup || 0,
                                y: d.heures_sup_moyennes || 0,
                                r: Math.max(8, Math.min(20, (d.heures_sup_moyennes || 0) * 2 + 5)),
                                service: d.libelle_y,
                                index: index
                            })),
                            backgroundColor: 'rgba(255, 159, 64, 0.6)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.raw;
                                        return point.service + ': ' + point.x + '% taux, ' + point.y + 'h moyennes';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                title: { display: true, text: 'Taux Heures Sup (%)' },
                                beginAtZero: true
                            },
                            y: { 
                                title: { display: true, text: 'Volume Heures Moyennes' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function createCategoriesCharts() {
            const categoriesData = dashboardData.categories || [];
            
            if (categoriesData.length > 0) {
                // R√©partition Cat√©gories - Doughnut chart
                initializeChart('categoriesChart', {
                    type: 'doughnut',
                    data: {
                        labels: categoriesData.map(d => d.categorie),
                        datasets: [{
                            data: categoriesData.map(d => d.nb_employes),
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', 
                                '#4BC0C0', '#9966FF', '#FF9F40'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + ' employ√©s';
                                    }
                                }
                            }
                        }
                    }
                });

                // Heures par Cat√©gorie - Bar chart
                initializeChart('categoriesHoursChart', {
                    type: 'bar',
                    data: {
                        labels: categoriesData.map(d => d.categorie),
                        datasets: [{
                            label: 'Heures Moyennes',
                            data: categoriesData.map(d => d.heures_moyennes),
                            backgroundColor: 'rgba(255, 159, 64, 0.8)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Heures moyennes par jour' }
                            }
                        }
                    }
                });
            }
        }

        function createEfficiencyCharts() {
            const efficiencyData = dashboardData.efficiency || [];
            
            if (efficiencyData.length > 0) {
                // Score Productivit√© - Horizontal bar chart
                initializeChart('productivityChart', {
                    type: 'bar',
                    data: {
                        labels: efficiencyData.map(d => d.service),
                        datasets: [{
                            label: 'Score Productivit√© (%)',
                            data: efficiencyData.map(d => d.score_productivite || 0),
                            backgroundColor: efficiencyData.map(d => {
                                const score = d.score_productivite || 0;
                                return score > 80 ? 'rgba(40, 167, 69, 0.8)' : 
                                       score > 60 ? 'rgba(255, 193, 7, 0.8)' : 
                                       'rgba(220, 53, 69, 0.8)';
                            }),
                            borderColor: efficiencyData.map(d => {
                                const score = d.score_productivite || 0;
                                return score > 80 ? '#28a745' : 
                                       score > 60 ? '#ffc107' : 
                                       '#dc3545';
                            }),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: true }
                        },
                        scales: { 
                            x: { 
                                beginAtZero: true, 
                                max: 100,
                                title: { display: true, text: 'Score (%)' }
                            }
                        }
                    }
                });

                // Analyse Efficacit√© - Scatter chart
                initializeChart('efficiencyScatterChart', {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Services',
                            data: efficiencyData.map((d, index) => ({
                                x: d.heures_moyennes || 0,
                                y: d.coefficient_variation || 0,
                                r: Math.max(8, Math.min(20, (d.nb_employes || 1) * 2)),
                                service: d.service,
                                index: index
                            })),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.raw;
                                        return point.service + ': ' + point.x + 'h moyennes, ' + point.y + '% variation';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                title: { display: true, text: 'Heures Moyennes' },
                                beginAtZero: true
                            },
                            y: { 
                                title: { display: true, text: 'Coefficient de Variation (%)' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function createSeasonalityCharts() {
            const seasonalData = dashboardData.seasonality;
            
            if (seasonalData.season_summary && seasonalData.season_summary.length > 0) {
                // Seasonal radar chart
                initializeChart('seasonalChart', {
                    type: 'radar',
                    data: {
                        labels: seasonalData.season_summary.map(d => d.saison),
                        datasets: [{
                            label: 'Heures Moyennes',
                            data: seasonalData.season_summary.map(d => d.heures_moyennes),
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 3,
                            pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: { 
                            r: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Heures moyennes' }
                            }
                        }
                    }
                });

                // Seasonal trends line chart
                initializeChart('seasonTrendsChart', {
                    type: 'line',
                    data: {
                        labels: seasonalData.season_summary.map(d => d.saison),
                        datasets: [{
                            label: 'Employ√©s Moyens',
                            data: seasonalData.season_summary.map(d => d.employes_moyens),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Nombre d\'employ√©s moyens' }
                            }
                        }
                    }
                });
            }
        }

        // Table creation functions
        function createAllTables() {
            createYearlyStatsTable();
            createCategoriesTable();
            createEfficiencyTable();
            createIndividualTables();
        }

        function createYearlyStatsTable() {
            const tableBody = document.querySelector('#yearlyStatsTable tbody');
            const allYearlyData = dashboardData.yearlyTrends.yearly_overview || [];
            const filteredData = selectedYear !== null ? allYearlyData.filter(d => d.annee === selectedYear) : allYearlyData;
            const yearlyData = filteredData.length > 0 ? filteredData : allYearlyData;
            tableBody.innerHTML = '';
            
            yearlyData.forEach((row, index) => {
                const tr = document.createElement('tr');
                const evolution = index > 0 ? 
                    ((row.employes_uniques - yearlyData[index-1].employes_uniques) / yearlyData[index-1].employes_uniques * 100).toFixed(1) : 
                    0;
                const evolutionClass = evolution > 0 ? 'status-excellent' : evolution < 0 ? 'status-faible' : 'status-moyen';
                const evolutionIcon = evolution > 0 ? '‚Üó' : evolution < 0 ? '‚Üò' : '‚Üí';
                
                tr.innerHTML = `
                    <td><strong>${row.annee}</strong></td>
                    <td>${row.employes_uniques}</td>
                    <td>${row.total_pointages.toLocaleString()}</td>
                    <td>${row.total_heures.toLocaleString()}h</td>
                    <td>${row.heures_moyennes_par_jour}h</td>
                    <td><span class="status-badge ${evolutionClass}">${evolutionIcon} ${evolution}%</span></td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function createCategoriesTable() {
            const tableBody = document.querySelector('#categoriesTable tbody');
            const categoriesData = dashboardData.categories || [];
            tableBody.innerHTML = '';
            
            categoriesData.forEach(row => {
                const tr = document.createElement('tr');
                const performance = row.heures_moyennes > 8 ? '√âlev√©e' : row.heures_moyennes > 6 ? 'Normale' : 'Faible';
                const perfClass = row.heures_moyennes > 8 ? 'status-excellent' : row.heures_moyennes > 6 ? 'status-moyen' : 'status-faible';
                
                tr.innerHTML = `
                    <td><strong>${row.categorie}</strong></td>
                    <td>${row.nb_employes}</td>
                    <td>${row.total_heures.toLocaleString()}h</td>
                    <td>${row.heures_moyennes}h</td>
                    <td>${row.total_pointages.toLocaleString()}</td>
                    <td><span class="status-badge ${perfClass}">${performance}</span></td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function createEfficiencyTable() {
            const tableBody = document.querySelector('#efficiencyTable tbody');
            const efficiencyData = dashboardData.efficiency || [];
            tableBody.innerHTML = '';
            
            efficiencyData.forEach(row => {
                const tr = document.createElement('tr');
                let statusClass = 'status-faible';
                let statusText = '√Ä Am√©liorer';
                
                if (row.score_productivite >= 80) {
                    statusClass = 'status-excellent';
                    statusText = 'Excellent';
                } else if (row.score_productivite >= 60) {
                    statusClass = 'status-moyen';
                    statusText = 'Satisfaisant';
                }
                
                tr.innerHTML = `
                    <td><strong>${row.service}</strong></td>
                    <td>${row.nb_employes}</td>
                    <td>${row.score_productivite}%</td>
                    <td>${row.coefficient_variation}%</td>
                    <td>${row.pointages_par_employe}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function createIndividualTables() {
            const individualData = dashboardData.individualPresence || {};

            const regularRows = individualData.top_regular || [];
            const irregularRows = individualData.top_irregular || [];

            populateIndividualHighlights(individualData, regularRows, irregularRows);
            renderIndividualCards('#regularEmployeesCards', regularRows);
            renderIndividualCards('#irregularEmployeesCards', irregularRows);
            createIndividualCharts(regularRows);
            populateEmployeeDirectoryOptions();
        }

        function populateIndividualHighlights(individualData, regularRows, irregularRows) {
            const container = document.getElementById('individualHighlights');
            if (!container) {
                return;
            }

            const fallback = (list, original) => {
                return original && original.length > 0 ? original[0] : null;
            };

            const bestEmployee = fallback(regularRows, individualData.top_regular);
            const riskEmployee = fallback(irregularRows, individualData.top_irregular);

            const services = individualData.service_breakdown || [];
            let disciplinedService = null;
            let atRiskService = null;
            if (services.length > 0) {
                disciplinedService = [...services].sort((a, b) => (b.score_regularite || 0) - (a.score_regularite || 0))[0];
                atRiskService = [...services].sort((a, b) => (a.score_regularite || 0) - (b.score_regularite || 0))[0];
            }

            const context = individualData.context || {};
            const businessDays = context.business_days || 0;
            const monthsWindow = context.months_window || 3;

            const highlightCards = [];
            highlightCards.push({
                title: "üóìÔ∏è Fen√™tre analys√©e",
                content: `${businessDays || '-'} jours ouvr√©s sur ${monthsWindow} mois`,
                detail: context.period_start && context.period_end
                    ? `Du ${new Date(context.period_start).toLocaleDateString()} au ${new Date(context.period_end).toLocaleDateString()}`
                    : 'P√©riode calcul√©e √† partir des pointages disponibles.'
            });

            if (bestEmployee) {
                highlightCards.push({
                    title: "‚úÖ Employ√© le plus r√©gulier",
                    content: `${bestEmployee.employe} (${bestEmployee.service || 'Service Inconnu'})`,
                    detail: `${bestEmployee.taux_assiduite || 0}% d'assiduit√© ¬∑ ${bestEmployee.avg_daily_hours?.toFixed ? bestEmployee.avg_daily_hours.toFixed(2) : bestEmployee.avg_daily_hours || 0}h/jour`
                });
            }

            if (riskEmployee) {
                const delay = typeof riskEmployee.retard_vs_objectif === 'number'
                    ? riskEmployee.retard_vs_objectif.toFixed(2)
                    : riskEmployee.retard_vs_objectif || 0;
                highlightCards.push({
                    title: "‚ö†Ô∏è Priorit√© de suivi",
                    content: `${riskEmployee.employe} (${riskEmployee.service || 'Service Inconnu'})`,
                    detail: `${riskEmployee.jours_sans_pointage || 0} jours manquants ¬∑ ${delay}h de retard`
                });
            }

            if (disciplinedService) {
                highlightCards.push({
                    title: "üèÜ Service exemplaire",
                    content: disciplinedService.service,
                    detail: `${(disciplinedService.score_regularite || 0).toFixed ? disciplinedService.score_regularite.toFixed(1) : disciplinedService.score_regularite || 0}% de score moyen`
                });
            }

            if (atRiskService && (!disciplinedService || atRiskService.service !== disciplinedService.service)) {
                highlightCards.push({
                    title: "üö® Service √† renforcer",
                    content: atRiskService.service,
                    detail: `${(atRiskService.taux_assiduite || 0).toFixed ? atRiskService.taux_assiduite.toFixed(1) : atRiskService.taux_assiduite || 0}% d'assiduit√© moyenne`
                });
            }

            if (highlightCards.length === 0) {
                container.innerHTML = '<p>Aucune donn√©e disponible pour calculer les insights individuels.</p>';
                return;
            }

            container.innerHTML = highlightCards.map(card => `
                <div class="insight-card">
                    <h4>${card.title}</h4>
                    <p><strong>${card.content}</strong></p>
                    <p>${card.detail || ''}</p>
                </div>
            `).join('');
        }

        function toggleChartEmptyState(canvasId, isEmpty) {
            const canvas = document.getElementById(canvasId);
            const emptyEl = document.getElementById(`${canvasId}Empty`);
            if (canvas) {
                canvas.style.display = isEmpty ? 'none' : 'block';
            }
            if (emptyEl) {
                emptyEl.style.display = isEmpty ? 'flex' : 'none';
            }
        }

        function createIndividualCharts(regularRows) {
            buildIndividualChart('regularEmployeesChart', regularRows, {
                colors: ['rgba(45, 212, 191, 0.85)', 'rgba(59, 130, 246, 0.85)', 'rgba(129, 140, 248, 0.85)', 'rgba(16, 185, 129, 0.85)'],
                borderColor: 'rgba(15, 118, 110, 1)'
            });
        }

        function buildIndividualChart(canvasId, rows, options = {}) {
            const topRows = rows.slice(0, 7);
            if (!topRows.length) {
                toggleChartEmptyState(canvasId, true);
                if (charts[canvasId]) {
                    charts[canvasId].destroy();
                    delete charts[canvasId];
                }
                return;
            }

            toggleChartEmptyState(canvasId, false);

            const labels = topRows.map(row => `${row.employe} ¬∑ ${row.service || 'Service Inconnu'}`);
            const scores = topRows.map(row => {
                const value = typeof row.score_regularite === 'number'
                    ? row.score_regularite
                    : parseFloat(row.score_regularite);
                if (Number.isNaN(value)) {
                    return 0;
                }
                return Math.max(0, Math.min(100, value));
            });

            const palette = options.colors || ['rgba(79, 70, 229, 0.85)'];
            const colors = topRows.map((_, index) => palette[index % palette.length]);
            const borderColor = options.borderColor || 'rgba(79, 70, 229, 1)';

            initializeChart(canvasId, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Score r√©gularit√© (%)',
                        data: scores,
                        backgroundColor: colors,
                        borderColor,
                        borderWidth: 1,
                        borderRadius: 8,
                        barThickness: 18
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: value => `${value}%`
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.3)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#0f172a',
                                autoSkip: false
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: context => {
                                    const row = topRows[context[0].dataIndex];
                                    return row ? row.employe : '';
                                },
                                label: context => {
                                    const row = topRows[context.dataIndex];
                                    const hours = typeof row.avg_daily_hours === 'number'
                                        ? row.avg_daily_hours.toFixed(2)
                                        : (row.avg_daily_hours || 0);
                                    const absence = row.jours_sans_pointage || 0;
                                    const attendance = typeof row.taux_assiduite === 'number'
                                        ? row.taux_assiduite.toFixed(1)
                                        : (row.taux_assiduite || 0);
                                    const scoreValue = context.parsed.x !== undefined && context.parsed.x !== null
                                        ? context.parsed.x.toFixed(1)
                                        : scores[context.dataIndex].toFixed(1);
                                    return `Score: ${scoreValue}% | ${hours}h/j | ${absence} j. manquants | ${attendance}% assiduit√©`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function populateEmployeeDirectoryOptions() {
            const select = document.getElementById('employeeSelect');
            if (!select) {
                return;
            }
            const individualData = dashboardData.individualPresence || {};
            employeeDirectory = individualData.employees_directory || [];

            const currentValue = select.value;
            select.innerHTML = '<option value=\"\">S√©lectionnez un employ√©</option>';
            employeeDirectory.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.mat_pers;
                const name = emp.employe || emp.mat_pers;
                const service = emp.service || 'Service Inconnu';
                option.textContent = `${name} (${service})`;
                select.appendChild(option);
            });

            if (currentValue && employeeDirectory.some(emp => String(emp.mat_pers) === currentValue)) {
                select.value = currentValue;
            }
        }

        async function onEmployeeFilterSubmit() {
            const select = document.getElementById('employeeSelect');
            const startInput = document.getElementById('employeeStart');
            const endInput = document.getElementById('employeeEnd');
            if (!select) {
                return;
            }

            const matPers = select.value;
            if (!matPers) {
                showEmployeeMessage('Veuillez s√©lectionner un employ√©.', 'error');
                return;
            }

            const start = startInput?.value || '';
            const end = endInput?.value || '';

            try {
                await loadEmployeePresence(matPers, start, end);
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es employ√©:', error);
                const message = error?.response?.data?.error || 'Impossible de r√©cup√©rer les donn√©es pour cet employ√©.';
                showEmployeeMessage(message, 'error');
            }
        }

        function resetEmployeeFilter() {
            const select = document.getElementById('employeeSelect');
            const startInput = document.getElementById('employeeStart');
            const endInput = document.getElementById('employeeEnd');
            if (select) select.value = '';
            if (startInput) startInput.value = '';
            if (endInput) endInput.value = '';
            const container = document.getElementById('employeeDrilldown');
            if (container) {
                container.style.display = 'none';
            }
            toggleChartEmptyState('employeeDrilldownChart', true);
            if (charts['employeeDrilldownChart']) {
                charts['employeeDrilldownChart'].destroy();
                delete charts['employeeDrilldownChart'];
            }
            const tableBody = document.querySelector('#employeeDrilldownTable tbody');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="5">En attente de s√©lection.</td></tr>';
            }
            showEmployeeMessage('S√©lectionnez un employ√© pour afficher ses d√©tails.', 'info');
        }

        function showEmployeeMessage(message, type = 'info') {
            const messageEl = document.getElementById('employeeDrilldownMessage');
            if (!messageEl) {
                return;
            }
            messageEl.textContent = message;
            messageEl.style.display = message ? 'block' : 'none';
            if (type === 'error') {
                messageEl.classList.add('alert-error');
            } else {
                messageEl.classList.remove('alert-error');
            }
        }

        async function loadEmployeePresence(matPers, start, end) {
            showEmployeeMessage('Chargement des donn√©es...', 'info');
            const params = new URLSearchParams({ mat_pers: matPers });
            if (start) params.append('start', start);
            if (end) params.append('end', end);

            const response = await axios.get(`/api/employee_presence?${params.toString()}`);
            employeeDrilldownData = response.data;
            renderEmployeeDrilldown(employeeDrilldownData);
            if (!employeeDrilldownData.status || employeeDrilldownData.status === 'ok') {
                showEmployeeMessage('');
            }
        }

        function renderEmployeeDrilldown(data) {
            const container = document.getElementById('employeeDrilldown');
            if (!container) {
                return;
            }

            const summary = data.summary || {};
            const daily = data.daily || [];
            if (data.status && data.status !== 'ok') {
                const statusMessages = {
                    not_found: 'Aucun employ√© trouv√© avec ce matricule.',
                    no_dates: 'Donn√©es de date indisponibles pour cet employ√©.',
                    no_records_in_range: 'Aucune pr√©sence enregistr√©e sur la p√©riode choisie.'
                };
                const message = statusMessages[data.status] || 'Impossible d\'afficher cette p√©riode.';
                showEmployeeMessage(message, 'error');
            }

            renderEmployeeDrilldownStats(summary, data.range);
            renderEmployeeDrilldownChart(daily);
            renderEmployeeDrilldownTable(daily);

            container.style.display = 'block';
        }

        function renderEmployeeDrilldownStats(summary, range) {
            const statsContainer = document.getElementById('employeeDrilldownStats');
            if (!statsContainer) {
                return;
            }

            const cards = [
                { label: 'Total Heures', value: `${summary.total_hours || 0}h`, icon: 'fa-hourglass-half' },
                { label: 'Moyenne / Jour', value: `${summary.average_hours || 0}h`, icon: 'fa-chart-line' },
                { label: 'Jours Pr√©sents', value: summary.presence_days || 0, icon: 'fa-calendar-check' },
                { label: 'Heures Sup', value: `${summary.overtime_hours || 0}h`, icon: 'fa-fire' }
            ];

            const periodText = range?.selected_start && range?.selected_end
                ? `${new Date(range.selected_start).toLocaleDateString()} ‚Üí ${new Date(range.selected_end).toLocaleDateString()}`
                : '';

            statsContainer.innerHTML = cards.map(card => `
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas ${card.icon}"></i></div>
                    <div class="stat-value">${card.value}</div>
                    <div class="stat-label">${card.label}</div>
                </div>
            `).join('') + (periodText ? `
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-calendar"></i></div>
                    <div class="stat-value" style="font-size:0.95rem">${periodText}</div>
                    <div class="stat-label">P√©riode analys√©e</div>
                </div>
            ` : '');
        }

        function renderEmployeeDrilldownChart(daily) {
            const canvasId = 'employeeDrilldownChart';
            if (!daily || daily.length === 0) {
                toggleChartEmptyState(canvasId, true);
                if (charts[canvasId]) {
                    charts[canvasId].destroy();
                    delete charts[canvasId];
                }
                return;
            }

            toggleChartEmptyState(canvasId, false);
            const sorted = [...daily].sort((a, b) => new Date(a.date) - new Date(b.date));
            initializeChart(canvasId, {
                type: 'line',
                data: {
                    labels: sorted.map(item => item.date),
                    datasets: [{
                        label: 'Heures travaill√©es',
                        data: sorted.map(item => item.heures),
                        borderColor: 'rgba(79, 70, 229, 1)',
                        backgroundColor: 'rgba(79, 70, 229, 0.15)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: context => {
                                    const record = sorted[context.dataIndex];
                                    return `${record.heures}h (HS: ${record.heures_sup || 0}h)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Heures' }
                        }
                    }
                }
            });
        }

        function renderEmployeeDrilldownTable(daily) {
            const tableBody = document.querySelector('#employeeDrilldownTable tbody');
            if (!tableBody) {
                return;
            }
            if (!daily || daily.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">Aucune donn√©e disponible pour cette p√©riode.</td></tr>';
                return;
            }
            const rows = daily
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(entry => `
                    <tr>
                        <td>${new Date(entry.date).toLocaleDateString()}</td>
                        <td>${entry.libelle_y || 'Service Inconnu'}</td>
                        <td>${entry.heures ?? 0}h</td>
                        <td>${entry.heures_sup ?? 0}h</td>
                        <td>${entry.presence_flag ? 'Oui' : 'Non'}</td>
                    </tr>
                `).join('');
            tableBody.innerHTML = rows;
        }

        function renderIndividualCards(selector, rows) {
            const container = document.querySelector(selector);
            if (!container) {
                return;
            }

            if (!rows.length) {
                container.innerHTML = '<div class="employee-card empty-state">Aucune donn√©e disponible pour cette s√©lection.</div>';
                return;
            }

            const formatHours = value => (typeof value === 'number' && !isNaN(value) ? value.toFixed(2) : '-');
            const formatInteger = value => (typeof value === 'number' && !isNaN(value) ? Math.round(value) : 0);
            const scoreClass = score => {
                if (typeof score !== 'number') {
                    return 'status-moyen';
                }
                if (score >= 80) return 'status-excellent';
                if (score >= 60) return 'status-moyen';
                return 'status-faible';
            };
            const formatScore = value => (typeof value === 'number' && !isNaN(value) ? value.toFixed(1) : '0.0');

            container.innerHTML = rows.map(row => `
                <div class="employee-card">
                    <span class="score-pill status-badge ${scoreClass(row.score_regularite)}">${formatScore(row.score_regularite)}%</span>
                    <h4><i class="fas fa-user"></i> ${row.employe || 'Employ√©'}</h4>
                    <div class="meta">
                        <span>${row.mat_pers || '-'}</span>
                        <span>${row.service || 'Service Inconnu'}</span>
                    </div>
                    <div class="metrics">
                        <span>${formatHours(row.avg_daily_hours)}h/j</span>
                        <span>${formatInteger(row.jours_pointes)} jours point√©s</span>
                        <span>${formatInteger(row.jours_sans_pointage)} jours manquants</span>
                    </div>
                </div>
            `).join('');
        }

        // Generate insights
        function generateInsights() {
            const container = document.getElementById('insightsContainer');
            const yearlyData = dashboardData.yearlyTrends.yearly_overview || [];
            const seasonalData = dashboardData.seasonality;
            
            let insights = [
                {
                    title: "üìä Vue d'Ensemble",
                    content: `Le syst√®me couvre ${dashboardData.summary.annees_couvertes?.length || 0} ann√©es de donn√©es avec ${dashboardData.summary.total_pointages?.toLocaleString() || 0} pointages au total.`
                }
            ];

            if (yearlyData.length >= 2) {
                const latestYear = yearlyData[yearlyData.length - 1];
                const previousYear = yearlyData[yearlyData.length - 2];
                const growth = ((latestYear.employes_uniques - previousYear.employes_uniques) / previousYear.employes_uniques * 100).toFixed(1);
                insights.push({
                    title: growth > 0 ? "üìà Croissance Positive" : "üìâ D√©croissance",
                    content: `${growth > 0 ? 'Augmentation' : 'Diminution'} de ${Math.abs(growth)}% du nombre d'employ√©s entre ${previousYear.annee} et ${latestYear.annee} (${previousYear.employes_uniques} ‚Üí ${latestYear.employes_uniques}).`
                });
            }

            if (dashboardData.categories.length > 0) {
                const mostActive = dashboardData.categories.reduce((max, cat) => 
                    cat.heures_moyennes > max.heures_moyennes ? cat : max
                );
                insights.push({
                    title: "üëî Cat√©gorie la Plus Active",
                    content: `La cat√©gorie "${mostActive.categorie}" travaille en moyenne ${mostActive.heures_moyennes}h par jour avec ${mostActive.nb_employes} employ√©s.`
                });
            }

            if (dashboardData.efficiency.length > 0) {
                const mostEfficient = dashboardData.efficiency.reduce((max, serv) => 
                    (serv.score_productivite || 0) > (max.score_productivite || 0) ? serv : max
                );
                insights.push({
                    title: "üèÜ Service le Plus Efficace",
                    content: `${mostEfficient.service} obtient un score de productivit√© de ${mostEfficient.score_productivite || 0}% avec ${mostEfficient.nb_employes} employ√©s.`
                });
            }

            if (seasonalData.season_summary?.length > 0) {
                const peakSeason = seasonalData.season_summary.reduce((max, season) => 
                    season.heures_moyennes > max.heures_moyennes ? season : max
                );
                insights.push({
                    title: "üçÇ Saison de Pointe",
                    content: `${peakSeason.saison} est la saison la plus active avec ${peakSeason.heures_moyennes}h moyennes de travail par jour.`
                });
            }

            if (dashboardData.overtime.length > 0) {
                const highestOvertime = dashboardData.overtime.reduce((max, serv) => 
                    (serv.taux_heures_sup || 0) > (max.taux_heures_sup || 0) ? serv : max
                );
                if (highestOvertime.taux_heures_sup > 0) {
                    insights.push({
                        title: "‚ö†Ô∏è Heures Suppl√©mentaires Critiques",
                        content: `${highestOvertime.libelle_y} a le taux d'heures suppl√©mentaires le plus √©lev√© (${highestOvertime.taux_heures_sup}%) avec ${highestOvertime.heures_sup_moyennes}h suppl√©mentaires moyennes.`
                    });
                }
            }

            const topRegular = dashboardData.individualPresence?.top_regular?.[0];
            if (topRegular) {
                const avgHours = typeof topRegular.avg_daily_hours === 'number'
                    ? topRegular.avg_daily_hours.toFixed(2)
                    : topRegular.avg_daily_hours || 0;
                insights.push({
                    title: "‚≠ê Employ√© Exemplaire",
                    content: `${topRegular.employe} (${topRegular.service}) maintient ${topRegular.taux_assiduite || 0}% d'assiduit√© avec ${avgHours}h moyennes/jour.`
                });
            }

            const topRisk = dashboardData.individualPresence?.top_irregular?.[0];
            if (topRisk) {
                const delay = typeof topRisk.retard_vs_objectif === 'number'
                    ? topRisk.retard_vs_objectif.toFixed(2)
                    : topRisk.retard_vs_objectif || 0;
                insights.push({
                    title: "üö® Employ√© √† Surveiller",
                    content: `${topRisk.employe} cumule ${topRisk.jours_sans_pointage || 0} jours sans pointage et un retard moyen de ${delay}h par rapport √† l'objectif.`
                });
            }



            if (dashboardData.peakHours?.length > 0) {
                const peakHour = dashboardData.peakHours.reduce((max, hour) => 
                    (hour.nombre_entrees || hour.mat_pers || 0) > (max.nombre_entrees || max.mat_pers || 0) ? hour : max
                );
                const rawHour = typeof peakHour.heure === 'number' ? peakHour.heure : peakHour.heure_entree_parsee;
                const hourValue = Number.isFinite(rawHour) ? rawHour : 0;
                const hourLabel = String(hourValue).padStart(2, '0');
                const entriesCount = (peakHour.nombre_entrees || peakHour.mat_pers || 0);
                insights.push({
                    title: "üïò Heure de Pointe",
                    content: `${hourLabel}h00 concentre ${entriesCount.toLocaleString()} entr√©es enregistr√©es.`
                });
            }

            if (dashboardData.peakHoursExit?.length > 0) {
                const peakHourExit = dashboardData.peakHoursExit.reduce((max, hour) => 
                    (hour.nombre_sorties || hour.mat_pers || 0) > (max.nombre_sorties || max.mat_pers || 0) ? hour : max
                );
                const rawHourExit = typeof peakHourExit.heure === 'number' ? peakHourExit.heure : peakHourExit.heure_sortie_parsee;
                const hourValueExit = Number.isFinite(rawHourExit) ? rawHourExit : 0;
                const hourLabelExit = String(Math.floor(hourValueExit)).padStart(2, '0');
                const exitsCount = (peakHourExit.nombre_sorties || peakHourExit.mat_pers || 0);
                insights.push({
                    title: "üïï Heure de Sortie",
                    content: `${hourLabelExit}h00 enregistre ${exitsCount.toLocaleString()} sorties.` 
                });
            }

            insights.push({
                title: "üí° Recommandation Strat√©gique",
                content: "Optimisez la couverture de pointage et la gestion des heures suppl√©mentaires pour renforcer la performance organisationnelle."
            });

            container.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <h4>${insight.title}</h4>
                    <p>${insight.content}</p>
                </div>
            `).join('');

            renderSeasonalCapacity(seasonalData.season_summary || []);
        }

        function renderSeasonalCapacity(seasonSummary) {
            const container = document.getElementById('seasonalInsights');
            if (!container) {
                return;
            }
            if (!seasonSummary.length) {
                container.innerHTML = '<p>Aucune donn√©e saisonni√®re disponible.</p>';
                return;
            }

            const cards = seasonSummary.map(season => `
                <div class="insight-card">
                    <h4>üåü ${season.saison}</h4>
                    <p>${season.employes_moyens} employ√©s moyens travaillant ${season.heures_moyennes}h par jour</p>
                </div>
            `);

            container.innerHTML = cards.join('');
        }


        function showLoader() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Show section and initialize charts
        function showTab(tabName) {
            // Hide all sections and deactivate nav items
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Show selected section and activate nav item
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            }

            const navItem = document.querySelector(`.nav-item[onclick="showTab('${tabName}')"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // Initialize charts for the active section
            setTimeout(() => {
                if (tabName === 'overview') {
                    safeCreateChart(createYearlyTrendsCharts, 'Yearly Trends Charts');
                } else if (tabName === 'hours') {
                    safeCreateChart(createWorkingHoursCharts, 'Working Hours Charts');
                } else if (tabName === 'overtime') {
                    safeCreateChart(createOvertimeCharts, 'Overtime Charts');
                } else if (tabName === 'patterns') {
                    safeCreateChart(createPatternCharts, 'Pattern Charts');
                } else if (tabName === 'categories') {
                    safeCreateChart(createCategoriesCharts, 'Categories Charts');
                } else if (tabName === 'individuals') {
                    createIndividualTables();
                } else if (tabName === 'efficiency') {
                    safeCreateChart(createEfficiencyCharts, 'Efficiency Charts');
                } else if (tabName === 'seasonality') {
                    safeCreateChart(createSeasonalityCharts, 'Seasonality Charts');
                }
            }, 100);
        }

        // Add error handling for chart creation
        function safeCreateChart(createFunction, chartName) {
            try {
                createFunction();
            } catch (error) {
                console.error(`Error creating ${chartName}:`, error);
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            lottie.loadAnimation({
                container: document.getElementById('lottie-loader'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: "{{ url_for('static', filename='Cred tick animation/animations/8423b319-eb5b-4189-aec9-759510b9ab15.json') }}"
            });
            ensureMonthFilterOptions();
            resetEmployeeFilter();
            initDashboard();
        });

        // Add window resize handler to redraw charts
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        });
        function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const toggleBtn = document.getElementById('themeToggle');
    toggleBtn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è Mode Clair' : 'üåô Mode Sombre';
    // Persist theme preference
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
}

// Load theme on page load
document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è Mode Clair';
    }
});
    </script>
</body>
</html>
